(globalThis.TURBOPACK||(globalThis.TURBOPACK=[])).push(["object"==typeof document?document.currentScript:void 0,16437,e=>{"use strict";let t="https://api.humanchat.com",s=async e=>{if(!e.ok)throw Error(await e.text().catch(()=>"")||"Request failed");return e.json()},i=async()=>{let e=await fetch(`${t}/api/auth/me`,{method:"GET",credentials:"include"});if(401===e.status)return null;let i=await s(e);return i?.user?i.user:i?.data?.user?i.data.user:i?.data&&"id"in i.data?i.data:null},r=async()=>{await fetch(`${t}/api/auth/logout`,{method:"POST",credentials:"include"})};e.s(["fetchCurrentUser",0,i,"logout",0,r])},51445,e=>{"use strict";e.s(["AUTH_UPDATED_EVENT",0,"humanchat-auth-updated"])},62265,43318,e=>{"use strict";e.i(47167);let t="https://api.humanchat.com",s=async(e,t)=>{if(!e.ok)throw Error(await e.text().catch(()=>"")||t);return e.json().catch(()=>({}))},i=async e=>s(await fetch(`${t}/api/sessions/${e}/start`,{method:"POST",credentials:"include"}),"Failed to mark session start"),r=async e=>s(await fetch(`${t}/api/sessions/${e}/end`,{method:"POST",credentials:"include"}),"Failed to mark session end"),a=async(e,i,{currency:r="usd",captureMethod:a="manual",finalAmount:n,mode:c="instant"}={})=>{let o=Math.max(0,Math.round(100*e)),l="number"==typeof n?Math.max(0,Math.round(100*n)):void 0;if(0===o)return{amount:e,currency:r};let h=await fetch(`${t}/api/payments/intent`,{method:"POST",credentials:"include",headers:{"Content-Type":"application/json"},body:JSON.stringify({amount:o,currency:r,sessionId:i,mode:c,captureMethod:a,metadata:{sessionId:i,paymentMode:c}})}),{intent:u}=await s(h,"Failed to create payment intent"),d=await fetch(`${t}/api/payments/capture`,{method:"POST",credentials:"include",headers:{"Content-Type":"application/json"},body:JSON.stringify({paymentIntentId:u?.id,finalAmount:l??o})});return await s(d,"Failed to capture payment"),{paymentIntentId:u?.id,amount:e,currency:r}},n=async(e,i,r="usd")=>s(await fetch(`${t}/api/payments/donation`,{method:"POST",credentials:"include",headers:{"Content-Type":"application/json"},body:JSON.stringify({sessionId:e,amount:i,currency:r})}),"Failed to start donation");e.s(["initiateDonation",0,n,"markSessionComplete",0,r,"markSessionStart",0,i,"processSessionPayment",0,a],43318);let c="https://api.humanchat.com",o=e=>({userId:e,isOnline:!1,hasActiveSession:!1,currentSessionId:void 0,lastUpdated:Date.now(),presenceState:"offline",lastSeenAt:null});class l{cache=new Map;subscribers=new Map;lastFetched=new Map;ws=null;syncTimer=null;currentUserId=null;isSyncing=!1;currentUserSubscribers=new Set;heartbeatTimer=null;lastActivity=Date.now();presenceState="offline";lastPresencePush=0;activityListenersAttached=!1;activityHandler=()=>{this.currentUserId&&(this.lastActivity=Date.now(),"idle"===this.presenceState&&this.pushPresence("active"))};visibilityHandler=()=>{this.currentUserId&&("hidden"===document.visibilityState?(this.lastActivity=Date.now()-6e4-1e3,this.pushPresence("idle")):this.activityHandler())};beforeUnloadHandler=()=>{if(this.currentUserId&&"function"==typeof navigator.sendBeacon)try{let e=new Blob([JSON.stringify({state:"offline"})],{type:"application/json"});navigator.sendBeacon(`${c}/api/users/me/presence`,e)}catch(e){console.warn("Presence beacon failed",e)}};constructor(){this.isBrowser()&&(this.currentUserId=this.resolveCurrentUserId(),this.attachPresenceTracking(),this.connectWebSocket(),this.startPeriodicSync())}setCurrentUserId(e){let t=this.currentUserId;!e&&t&&this.pushPresence("offline",t),this.currentUserId=e,e?(this.attachPresenceTracking(),this.activityHandler(),this.pushPresence("active")):this.presenceState="offline",this.currentUserSubscribers.forEach(t=>{try{t(e)}catch(e){console.warn("Current user listener failed",e)}})}getCurrentUserId(){return this.currentUserId}onCurrentUserChange(e){return this.currentUserSubscribers.add(e),e(this.currentUserId),()=>{this.currentUserSubscribers.delete(e)}}async startSession(e,t){await i(e);let s=this.updateStatus(t,{hasActiveSession:!0,currentSessionId:e,isOnline:!0});return this.broadcast(t),s}async endSession(e,t){await r(e);let s=this.updateStatus(t,{hasActiveSession:!1,currentSessionId:void 0});return this.broadcast(t),s}async checkUserStatus(e){let t=Date.now(),s=this.lastFetched.get(e),i=this.cache.get(e);return i&&s&&t-s<3e4?i:await this.fetchStatus(e)??o(e)}async syncStatusWithBackend(){if(!this.isSyncing){this.isSyncing=!0;try{let e=Array.from(this.cache.keys());if(0===e.length)return;await Promise.all(e.map(e=>this.fetchStatus(e).catch(()=>void 0)))}finally{this.isSyncing=!1}}}subscribeToStatusChanges(e,t){let s=this.subscribers.get(e)??new Set;s.add(t),this.subscribers.set(e,s);let i=this.cache.get(e);return i&&t(i),()=>{let s=this.subscribers.get(e);s?.delete(t),s&&0===s.size&&this.subscribers.delete(e)}}async fetchStatus(e){let t=await this.withRetry(()=>fetch(`${c}/api/users/${e}/status`,{method:"GET",credentials:"include"}));if(!t.ok)throw Error(`Failed to fetch status for ${e}`);let s=await t.json(),i={...o(e),isOnline:!!s.isOnline,hasActiveSession:!!s.hasActiveSession,presenceState:s.presenceState??(s.isOnline?"active":"offline"),lastSeenAt:s.lastSeenAt?Date.parse(s.lastSeenAt):null,userId:e,lastUpdated:Date.now()};return this.cache.set(e,i),this.lastFetched.set(e,Date.now()),this.broadcast(e),i}updateStatus(e,t){let s={...this.cache.get(e)??o(e),...t,userId:e,lastUpdated:Date.now()};return this.cache.set(e,s),this.lastFetched.set(e,Date.now()),s}broadcast(e){let t=this.cache.get(e);if(!t)return;let s=this.subscribers.get(e);s?.forEach(e=>{try{e(t)}catch(e){console.warn("Session status subscriber failed",e)}})}connectWebSocket(){if(!this.ws&&this.isBrowser())try{this.ws=new WebSocket(`${"wss://ws.humanchat.com".replace(/\/$/,"")}/status`),this.ws.addEventListener("message",e=>{try{let t=JSON.parse(e.data);if(!t?.userId)return;this.cache.set(t.userId,{...o(t.userId),...t,presenceState:t.presenceState??(t.isOnline?"active":"offline")}),this.lastFetched.set(t.userId,Date.now()),this.broadcast(t.userId)}catch(e){console.warn("Failed to parse status update",e)}}),this.ws.addEventListener("close",()=>{this.ws=null,setTimeout(()=>this.connectWebSocket(),2e3)}),this.ws.addEventListener("error",()=>{this.ws?.close()})}catch(e){console.warn("WebSocket connection failed",e)}}startPeriodicSync(){!this.syncTimer&&this.isBrowser()&&(this.syncTimer=setInterval(()=>{this.syncStatusWithBackend().catch(e=>{console.warn("Status sync failed",e)})},3e4))}async withRetry(e,t=0){try{return await e()}catch(i){if(t>=3)throw i instanceof Error?i:Error(String(i));let s=1e3*Math.pow(2,t);return await new Promise(e=>setTimeout(e,s)),this.withRetry(e,t+1)}}isBrowser(){return!0}attachPresenceTracking(){!this.isBrowser()||this.activityListenersAttached||(["mousemove","keydown","click","touchstart"].forEach(e=>window.addEventListener(e,this.activityHandler,{passive:!0})),window.addEventListener("focus",this.activityHandler),document.addEventListener("visibilitychange",this.visibilityHandler),window.addEventListener("beforeunload",this.beforeUnloadHandler),this.startHeartbeat(),this.activityListenersAttached=!0)}startHeartbeat(){this.heartbeatTimer||(this.pushPresence("active"),this.heartbeatTimer=setInterval(()=>{if(!this.currentUserId)return;let e=Date.now()-this.lastActivity>6e4;this.pushPresence(e?"idle":"active")},45e3))}async pushPresence(e,t){if(!(t??this.currentUserId))return;let s=Date.now();if(t||e!==this.presenceState||!(s-this.lastPresencePush<22500))try{await fetch(`${c}/api/users/me/presence`,{method:"POST",credentials:"include",headers:{"Content-Type":"application/json"},body:JSON.stringify({state:e})}),t||(this.presenceState=e,this.lastPresencePush=s)}catch(e){console.warn("Presence update failed",e)}}resolveCurrentUserId(){let e=this.isBrowser()?window:void 0;if(!e)return null;let t=e.__HUMANCHAT_USER_ID__;if("string"==typeof t)return t;try{let t=e.localStorage?.getItem("humanchat:userId");if(t)return t}catch(e){console.warn("Unable to read stored user id",e)}return null}}let h=new l;e.s(["sessionStatusManager",0,h],62265)},35833,e=>{"use strict";let t=async()=>{if(!("serviceWorker"in navigator))return null;try{return await navigator.serviceWorker.ready}catch(e){return console.warn("Service worker not ready",e),null}},s=async()=>{if(!("Notification"in window))return console.warn("Notifications not supported"),!1;if("default"===Notification.permission)try{await Notification.requestPermission()}catch(e){console.warn("Notification permission request failed",e)}return"granted"===Notification.permission},i=async(e,s,i,r)=>{let a=await t();a&&"granted"===Notification.permission&&await a.showNotification(e,{body:s,tag:r,data:i,icon:"/icon.svg",badge:"/icon.svg"})},r=async(e,t)=>{("undefined"==typeof document||"visible"!==document.visibilityState)&&await i(`New message from ${e}`,t,{type:"message"},`message-${e}`)},a=async(e,t)=>{let s=new Intl.NumberFormat(void 0,{style:"currency",currency:t}).format(e/100);await i("Payment complete",`${s} captured successfully.`,{type:"payment"},"payment")},n=async(e,t)=>{let s=Math.max(0,e-3e5)-Date.now(),r=async()=>{await i("Session starting soon",`${t} joins in 5 minutes.`,{type:"call_reminder",hostName:t,startTime:e})};s<=0?await r():window.setTimeout(()=>{r()},s)};e.s(["initializeNotifications",0,s,"notifyNewMessage",0,r,"notifyPaymentComplete",0,a,"scheduleCallReminder",0,n])},8477,e=>{"use strict";var t=e.i(71645),s=e.i(35833);function i(){return(0,t.useEffect)(()=>{if(!("serviceWorker"in navigator))return;(async()=>{try{let e=await navigator.serviceWorker.register("/sw.js",{scope:"/"});e.sync&&await e.sync.register("sync-messages").catch(()=>void 0)}catch(e){console.warn("Service worker registration failed",e)}})();let e=e=>{e.data?.type==="SYNC_MESSAGES"&&window.dispatchEvent(new CustomEvent("humanchat-sync"))};return navigator.serviceWorker.addEventListener("message",e),()=>{navigator.serviceWorker.removeEventListener("message",e)}},[]),(0,t.useEffect)(()=>{(0,s.initializeNotifications)()},[]),null}e.s(["default",()=>i])},80761,e=>{"use strict";var t=e.i(71645);e.i(51718);var s=e.i(18357),i=e.i(97822),r=e.i(51445);let a="hc_email_link",n=()=>{window.dispatchEvent(new CustomEvent(r.AUTH_UPDATED_EVENT))};function c(){let e=(0,t.useRef)(!1),r=(0,t.useRef)(null);return(0,t.useEffect)(()=>{let t=i.firebaseAuth,c=!0,o=async t=>{if(t&&!e.current&&r.current!==t){e.current=!0;try{(await fetch("https://api.humanchat.com/api/auth/firebase",{method:"POST",credentials:"include",headers:{"Content-Type":"application/json"},body:JSON.stringify({idToken:t})})).ok?(r.current=t,n()):(r.current=null,console.error("Failed to bridge Firebase session"))}catch(e){r.current=null,console.error("Unable to sync Firebase session",e)}finally{e.current=!1}}};(async()=>{if(!(0,s.isSignInWithEmailLink)(t,window.location.href))return;let e=window.localStorage.getItem(a);if(e||(e=window.prompt("Enter the email you used to request the sign-in link")??""),e)try{await (0,s.signInWithEmailLink)(t,e,window.location.href),window.localStorage.removeItem(a);let i=new URL(window.location.href);i.searchParams.delete("oobCode"),i.searchParams.delete("mode"),i.searchParams.delete("lang"),window.history.replaceState({},document.title,i.pathname+i.search+i.hash)}catch(e){console.error("Unable to complete email link sign in",e)}})();let l=(0,s.onIdTokenChanged)(t,async e=>{if(c){if(!e){r.current=null,n();return}try{let t=await e.getIdToken();await o(t)}catch(e){console.error("Unable to fetch Firebase ID token",e)}}});return()=>{c=!1,l()}},[]),null}e.s(["default",()=>c])},72728,e=>{"use strict";var t=e.i(71645),s=e.i(51445),i=e.i(16437),r=e.i(62265);let a="humanchat:userId";function n(){return(0,t.useEffect)(()=>{let e=!1,t=!1,n=!1,c=async()=>{if(t){n=!0;return}t=!0;try{let t=await (0,i.fetchCurrentUser)();e||(e=>{r.sessionStatusManager.setCurrentUserId(e);let t=window;if(e){t.__HUMANCHAT_USER_ID__=e;try{window.localStorage?.setItem(a,e)}catch(e){}}else{delete t.__HUMANCHAT_USER_ID__;try{window.localStorage?.removeItem(a)}catch(e){}}})(t?.id??null)}catch(t){e||console.warn("Failed to load current user identity",t)}finally{t=!1,n&&!e&&(n=!1,c())}};c();let o=()=>{c()};return window.addEventListener(s.AUTH_UPDATED_EVENT,o),()=>{e=!0,window.removeEventListener(s.AUTH_UPDATED_EVENT,o)}},[]),null}e.s(["default",()=>n])}]);